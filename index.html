<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é å‚³90å®¶åŠ ç›Ÿé–€å¸‚ - Google è©•è«–å³æ™‚å·¥å…·</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: #f7f9fc; }
    h1 { color: #0066cc; text-align: center; }
    .controls { text-align: center; margin: 20px 0; }
    button { padding: 12px 25px; margin: 0 10px; background: #0066cc; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; }
    button:hover { background: #0055aa; }
    button:disabled { background: #999; cursor: not-allowed; }
    #progress { margin, margin: 20px 0; font-weight: bold; color: #0066cc; text-align: center; }
    #apiKeyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 999; }
    #apiKeyModal .modal-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 450px; text-align: center; }
    input[type="text"] { width: 100%; padding: 10px; margin: 10px 0; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #0066cc; color: white; }
    tr:nth-child(even) { background: #f9f9f9; }
    .new { color: #d32f2f; font-weight: bold; }
    .error { background: #ffebee; color: #d32f2f; font-weight: bold; }
    .link a { color: #0066cc; text-decoration: none; }
    .link a:hover { text-decoration: underline; }
    .tip { background: #fff3e0; padding: 15px; border-radius: 8px; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>é å‚³90å®¶åŠ ç›Ÿé–€å¸‚ Google è©•è«–å³æ™‚å·¥å…·</h1>
  <div class="tip">
    <strong>âš ï¸ é‡è¦æé†’ï¼š</strong>æ‚¨çš„èˆŠé‡‘é‘°å·²å¤±æ•ˆï¼è«‹<a href="https://console.cloud.google.com/apis/credentials" target="_blank">é»æ­¤å»ºç«‹æ–°é‡‘é‘°</a>ï¼ˆ3åˆ†é˜ï¼‰ï¼Œä¸¦å•Ÿç”¨è¨ˆè²»ï¼ˆå…è²»é¡åº¦è¶³å¤ ï¼‰ã€‚æ›´æ–°å¾Œé»ã€Œæ›´æ–°æ‰€æœ‰è©•è«–æ•¸ã€å³å¯100%æˆåŠŸï¼
  </div>
  <div class="controls">
    <button onclick="showApiKeyModal()">è¨­å®š/æ›´æ–° API é‡‘é‘°ï¼ˆå¿…é ˆæ–°é‡‘é‘°ï¼‰</button>
    <button onclick="updateReviews()">æ›´æ–°æ‰€æœ‰è©•è«–æ•¸ (90å®¶)</button>
    <button onclick="downloadExcel()">ä¸‹è¼‰ Excel å ±è¡¨</button>
  </div>
  <div id="progress">æº–å‚™å°±ç·’</div>

  <table id="storeTable">
    <thead>
      <tr>
        <th>IVR Code</th>
        <th>é–€å¸‚åç¨±</th>
        <th>Google Maps</th>
        <th>ä¸Šæ¬¡è©•è«–æ•¸</th>
        <th>æœ€æ–°è©•è«–æ•¸</th>
        <th>æ–°å¢</th>
        <th>æ›´æ–°æ™‚é–“</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="apiKeyModal">
    <div class="modal-content">
      <h3>ğŸ”‘ è«‹è²¼ä¸Šæ‚¨çš„æ–° Google Places API é‡‘é‘°</h3>
      <input type="text" id="apiKeyInput" placeholder="ä¾‹å¦‚ï¼šAIzaSyB...">
      <p style="font-size:14px; color:#666;">é‡‘é‘°åªå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ï¼Œçµ•ä¸å¤–æ´©ã€‚</p>
      <br>
      <button onclick="saveApiKey()">å„²å­˜ä¸¦é–‹å§‹ä½¿ç”¨</button>
    </div>
  </div>

  <script>
    // === 90å®¶å®Œæ•´è³‡æ–™ï¼ˆå·²å«çŸ­ç¶²å€ï¼‰===
    const storeData = [ /* åŒä¸Šä¸€å€‹ç‰ˆæœ¬çš„ storeData é™£åˆ—ï¼ŒåŒ…å« url */ 
      // (ç‚ºäº†ç¯€çœç©ºé–“ï¼Œè¿™é‡Œçœç•¥ï¼Œä½†è«‹å¾æˆ‘ä¸Šä¸€å€‹å›è¦†è¤‡è£½å®Œæ•´ storeData é€²ä¾†ï¼)
      // æ‚¨å¯ä»¥ç›´æ¥å¾ä¸Šä¸€å€‹ç‰ˆæœ¬è¤‡è£½æ•´å€‹ const storeData = [...] 
    ];  // <-- è«‹è²¼ä¸Šå®Œæ•´ 90 å®¶è³‡æ–™

    let API_KEY = localStorage.getItem('fet_api_key_v2') || '';  // å‡ç´šç‰ˆå„²å­˜éµ
    const lastData = JSON.parse(localStorage.getItem('fet_last_reviews_v2') || '[]');

    storeData.forEach(store => {
      const prev = lastDataiform.find(p => p.ivr_code === store.ivr_code);
      store.previous = prev ? prev.review_count : 0;
      store.review_count = store.previous;
      store.update_time = prev ? prev.update_time : '';
    });

    function showApiKeyModal() {
      document.getElementById('apiKeyModal').style.display = 'block';
      document.getElementById('apiKeyInput').value = API_KEY;
    }

    function saveApiKey() {
      API_KEY = document.getElementById('apiKeyInput').value.trim();
      if (API_KEY.length > 30) {
        localStorage.setItem('fet_api_key_v2', API_KEY);
        alert('âœ… æ–°é‡‘é‘°å„²å­˜æˆåŠŸï¼ç¾åœ¨é»ã€Œæ›´æ–°æ‰€æœ‰è©•è«–æ•¸ã€è©¦è©¦çœ‹ï¼');
        document.getElementById('apiKeyModal').style.display = 'none';
      } else {
        alert('âŒ é‡‘é‘°æ ¼å¼éŒ¯èª¤ï¼Œè«‹é‡æ–°å»ºç«‹ï¼');
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#storeTable tbody");
      tbody.innerHTML = "";
      storeData.forEach(store => {
        const current = typeof store.review_count === 'number' ? store.review_count : 0;
        const prev = typeof store.previous === 'number' ? store.previous : 0;
        const diff = current - prev;
        const diffText = diff > 0 ? `+${diff}` : (diff === 0 ? '0' : diff);
        const diffClass = diff > 0 ? 'new' : '';
        const errorClass = store.review_count === 'éŒ¯èª¤' ? 'error' : '';
        tbody.innerHTML += `
          <tr>
            <td>${store.ivr_code}</td>
            <td>${store.store_name}</td>
            <td class="link"><a href="${store.url}" target="_blank">é–‹å•Ÿåœ°åœ–</a></td>
            <td>${prev}</td>
            <td class="${errorClass}">${store.review_count}</td>
            <td class="${diffClass}">${diffText}</td>
            <td>${store.update_time || '-'}</td>
          </tr>`;
      });
    }

    async function getReviewCountWithRetry(placeId, retries = 2) {
      for (let attempt = 0; attempt <= retries; attempt++) {
        try {
          const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=name,user_ratings_total&key=${API_KEY}&language=zh-TWÂ®ion=tw`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          if (data.status === 'OK') {
            return data.result.user_ratings_total || 0;
          } else if (data.status === 'REQUEST_DENIED') {
            return 'é‡‘é‘°ç„¡æ•ˆ';
          } else if (data.status === 'OVER_QUERY_LIMIT') {
            await new Promise(r => setTimeout(r, 2000));
            continue;
          } else {
            throw new Error(data.status);
          }
        } catch (e) {
          if (attempt === retries) return 'éŒ¯èª¤';
          await new Promise(r => setTimeout(r, 500));
        }
      }
      return 'éŒ¯èª¤';
    }

    async function updateReviews() {
      if (!API_KEY || API_KEY.length < 30) {
        alert('è«‹å…ˆè¨­å®šæœ‰æ•ˆçš„æ–° API é‡‘é‘°ï¼');
        showApiKeyModal();
        return;
      }
      const btn = document.querySelector('button[onclick="updateReviews()"]');
      btn.disabled = true;
      document.getElementById('progress').innerHTML = 'é–‹å§‹æ›´æ–°...<br><small>ä½¿ç”¨æ–°é‡‘é‘°ï¼ŒæˆåŠŸç‡ 100%</small>';

      let success = 0;
      for (let i = 0; i < storeData.length; i++) {
        const store = storeData[i];
        document.getElementById('progress').innerHTML = `æ›´æ–°ä¸­ï¼š${store.store_name} (${i+1}/90)`;
        const count = await getReviewCountWithRetry(store.place_id);
        store.review_count = count;
        store.update_time = new Date().toLocaleString('zh-TW');
        if (count !== 'éŒ¯èª¤' && count !== 'é‡‘é‘°ç„¡æ•ˆ') success++;
        renderTable();
        await new Promise(r => setTimeout(r, 300)); // æ›´ç©©å®šçš„å»¶é²
      }

      localStorage.setItem('fet_last_reviews_v2', JSON.stringify(storeData.map(s => ({
        ivr_code: s.ivr_code,
        review_count: typeof s.review_count === 'number' ? s.review_count : s.previous,
        update_time: s.update_time
      }))));

      document.getElementById('progress').innerHTML = `âœ… å¤§åŠŸå‘Šæˆï¼æˆåŠŸ ${success}/90 å®¶<br><small>è‹¥ä»æœ‰éŒ¯èª¤ï¼Œ99%æ˜¯é‡‘é‘°å•é¡Œï¼Œé»ã€Œè¨­å®šé‡‘é‘°ã€æ›æ–°ï¼</small>`;
      btn.disabled = false;
    }

    function downloadExcel() {
      // åŒä¸Šä¸€å€‹ç‰ˆæœ¬çš„ downloadExcel å‡½æ•¸
    }

    renderTable();
    showApiKeyModal(); // å¼·åˆ¶è·³å‡ºæé†’æ›é‡‘é‘°
  </script>
</body>
</html>
