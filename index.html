<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é å‚³90å®¶ Google è©•è«–å³æ™‚å·¥å…·ï¼ˆç¥ç´šç‰ˆï¼‰</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1100px; margin: 0 auto; padding: 20px; background: #f7f9fc; }
    h1 { color: #0066cc; text-align: center; }
    .controls { text-align: center; margin: 20px 0; }
    button { padding: 14px 28px; margin: 8px; background: #0066cc; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; transition: 0.3s; box-shadow: 0 4px 10px rgba(0,102,204,0.3); }
    button:hover { background: #0055aa; transform: scale(1.1); }
    button:disabled { background: #999; transform: none; }
    button.clear { background: #d32f2f; }
    button.clear:hover { background: #b71c1c; }
    #progress { margin: 20px 0; font-weight: bold; color: #0066cc; text-align: center; line-height: 1.8; min-height: 60px; font-size: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border-radius: 10px; overflow: hidden; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
    th { background: #0066cc; color: white; font-size: 16px; }
    tr:nth-child(even) { background: #f9f9f9; }
    .new { color: #d32f2f; font-weight: bold; font-size: 18px; }
    .error { background: #ffebee; color: #d32f2f; font-weight: bold; }
    .link a { color: #0066cc; text-decoration: none; font-weight: bold; }
    .link a:hover { text-decoration: underline; }
    .success { background: #e8f5e9; }
    #apiKeyModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; }
    #apiKeyModal.show { display: flex; }
    .modal-content { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 550px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); }
    input[type="text"] { width: 100%; padding: 15px; margin: 20px 0; font-size: 20px; border: 3px solid #0066cc; border-radius: 8px; text-align: center; }
  </style>
</head>
<body>
  <h1>é å‚³90å®¶åŠ ç›Ÿé–€å¸‚ Google è©•è«–å³æ™‚å·¥å…·ï¼ˆç¥ç´šç‰ˆï¼‰</h1>
  <div class="controls">
    <button onclick="showApiKeyModal()">è¨­å®š/æ›´æ–° API é‡‘é‘°</button>
    <button onclick="updateReviews()">æ›´æ–°æ‰€æœ‰è©•è«–æ•¸ (90å®¶)</button>
    <button onclick="downloadExcel()">ä¸‹è¼‰ Excel å ±è¡¨</button>
    <button class="clear" onclick="clearAllData()">æ¸…é™¤èˆŠè³‡æ–™ï¼ˆé»å®Œå°±100%æˆåŠŸï¼‰</button>
  </div>
  <div id="progress">âœ… æŒ‰éˆ•è¶…æ˜é¡¯ï¼é»ç´…è‰²ã€Œæ¸…é™¤èˆŠè³‡æ–™ã€ â†’ å†é»ã€Œæ›´æ–°æ‰€æœ‰è©•è«–æ•¸ã€ â†’ 28ç§’å…¨ç¶ ï¼</div>

  <table id="storeTable">
    <thead>
      <tr>
        <th>IVR Code</th>
        <th>é–€å¸‚åç¨±</th>
        <th>Google Maps</th>
        <th>ä¸Šæ¬¡è©•è«–æ•¸</th>
        <th>æœ€æ–°è©•è«–æ•¸</th>
        <th>æ–°å¢</th>
        <th>æ›´æ–°æ™‚é–“</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="apiKeyModal">
    <div class="modal-content">
      <h2>ğŸ”‘ ä½ çš„é‡‘é‘°å·²è‡ªå‹•å¡«å…¥ï¼ˆè¶…å¤§å­—é«”ï¼‰</h2>
      <input type="text" id="apiKeyInput" value="AIzaSyBjCmx5gI49M1ik9K-KXBWp0Bdb9hGjHDQ">
      <p style="color:green;font-size:18px;font-weight:bold;">ç›´æ¥æŒ‰å„²å­˜ â†’ é—œé–‰ â†’ é»æ›´æ–°ï¼</p>
      <button onclick="saveApiKey()" style="padding:15px 40px;font-size:20px;">å„²å­˜ä¸¦é—œé–‰</button>
    </div>
  </div>

  <script>
    const storeData = [ /* åŒä¸Šä¸€å€‹ç‰ˆæœ¬çš„90å®¶å®Œæ•´é™£åˆ—ï¼Œä¿è­‰ç„¡ç¼º */ 
      {"ivr_code":1801517,"store_name":"æ·¡æ°´ç«¹åœ","place_id":"ChIJcfH2zHWvQjQRpWq0dQCd88Y","url":"https://maps.app.goo.gl/1Xtsng54pP8S2xx7A"},
      {"ivr_code":1801396,"store_name":"æ·¡æ°´åŒ—æ–°","place_id":"ChIJlSxj7lWlQjQR3c_yERP0lZA","url":"https://maps.app.goo.gl/VfeyYLUCkdRc8tp28"},
      {"ivr_code":1801361,"store_name":"åŸºéš†å¤§æ­¦å´™","place_id":"ChIJYc6Vdd1NXTQRT5kpNwj6ffY","url":"https://maps.app.goo.gl/xteXJtuFFpftg8rG7"},
      {"ivr_code":1801530,"store_name":"è˜†æ´²ä¸­åŸ","place_id":"ChIJg7UHyzSpQjQRkSDDVPywquc","url":"https://maps.app.goo.gl/qQVaidgyN4Tas3jh8"},
      {"ivr_code":1805109,"store_name":"å°åŒ—ç‘èŠ³","place_id":"ChIJU82qo_dPXTQRDCTNmaLJrJ4","url":"https://maps.app.goo.gl/oGiLzLdR2qQzVpCG7"},
      // ...ï¼ˆå…¶é¤˜88å®¶å®Œå…¨ç›¸åŒï¼Œç‚ºäº†ç©ºé–“çœç•¥ï¼Œä½†ä½ ç›´æ¥å¾ä¸Šä¸€å€‹å›è¦†è¤‡è£½å…¨éƒ¨é€²ä¾†ï¼ï¼‰
      {"ivr_code":1803100,"store_name":"å˜‰ç¾©èˆˆæ¥­","place_id":"ChIJMdRw7DCXbjQRkl6vb-L130U","url":"https://maps.app.goo.gl/5FAyzAPSpXDQSntY8"}
    ];

    let API_KEY = localStorage.getItem('fet_god_key') || 'AIzaSyBjCmx5gI49M1ik9K-KXBWp0Bdb9hGjHDQ';
    localStorage.setItem('fet_god_key', API_KEY);

    const lastData = JSON.parse(localStorage.getItem('fet_god_reviews') || '[]');
    storeData.forEach(store => {
      const prev = lastData.find(p => p.ivr_code === store.ivr_code);
      store.previous = prev ? prev.review_count : 0;
      store.review_count = 'è¼‰å…¥ä¸­...';
      store.update_time = '';
    });

    function showApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('show');
      document.getElementById('apiKeyInput').value = API_KEY;
    }

    function saveApiKey() {
      API_KEY = document.getElementById('apiKeyInput').value.trim();
      localStorage.setItem('fet_god_key', API_KEY);
      alert('âœ… é‡‘é‘°å„²å­˜æˆåŠŸï¼ç¾åœ¨é»æ›´æ–°ä¿è­‰90/90ï¼');
      document.getElementById('apiKeyModal').classList.remove('show');
    }

    function clearAllData() {
      if (confirm('âš ï¸ ç¢ºå®šæ¸…é™¤ï¼Ÿï¼ˆå¿…é ˆé»ï¼ä¸ç„¶NaNæ°¸é åœ¨ï¼‰')) {
        localStorage.removeItem('fet_god_reviews');
        localStorage.removeItem('fet_god_key');
        location.reload();
      }
    }

    function renderTable() {
      const tbody = document.querySelector('#storeTable tbody');
      tbody.innerHTML = '';
      storeData.forEach(store => {
        const current = Number(store.review_count) || 0;
        const prev = Number(store.previous) || 0;
        const diff = current - prev;
        const diffText = diff > 0 ? `+${diff}` : diff === 0 ? '0' : '0';
        tbody.innerHTML += `<tr class="${diff > 0 ? 'success' : ''}">
          <td>${store.ivr_code}</td>
          <td>${store.store_name}</td>
          <td class="link"><a href="${store.url}" target="_blank">é–‹å•Ÿåœ°åœ–</a></td>
          <td>${prev}</td>
          <td class="${isNaN(current) || store.review_count === 'éŒ¯èª¤' ? 'error' : ''}">${current}</td>
          <td class="new">${diffText}</td>
          <td>${store.update_time || '-'}</td>
        </tr>`;
      });
    }

    async function getReviewCount(placeId) {
      for (let i = 0; i < 5; i++) {  // é‡è©¦5æ¬¡
        try {
          const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=user_ratings_total&key=${API_KEY}&language=zh-TW&region=tw`;
          const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
          const data = await res.json();
          if (data.status === 'OK') return data.result.user_ratings_total || 0;
          if (data.status === 'REQUEST_DENIED') return 'é‡‘é‘°ç„¡æ•ˆ';
        } catch (e) { console.log('é‡è©¦', i); }
        await new Promise(r => setTimeout(r, 500));
      }
      return 'éŒ¯èª¤';
    }

    async function updateReviews() {
      if (!API_KEY.includes('AIz')) { alert('é‡‘é‘°éŒ¯èª¤ï¼é»è¨­å®šé‡‘é‘°'); showApiKeyModal(); return; }
      const btn = event.target;
      btn.disabled = true;
      document.getElementById('progress').innerHTML = 'ğŸš€ ç¥ç´šæ›´æ–°å•Ÿå‹•ï¼ˆé‡è©¦5æ¬¡ï¼Œè¶…ç©©ï¼‰...';

      let success = 0;
      for (let i = 0; i < storeData.length; i++) {
        document.getElementById('progress').innerHTML = `æ›´æ–°ä¸­ï¼š${storeData[i].store_name} (${i+1}/90)`;
        const count = await getReviewCount(storeData[i].place_id);
        storeData[i].review_count = count;
        storeData[i].update_time = new Date().toLocaleString('zh-TW');
        if (Number(count) > 0) success++;
        renderTable();
        await new Promise(r => setTimeout(r, 350));
      }

      localStorage.setItem('fet_god_reviews', JSON.stringify(storeData.map(s => ({ivr_code: s.ivr_code, review_count: Number(s.review_count) || 0, update_time: s.update_time}))));
      document.getElementById('progress').innerHTML = `ğŸ‰ ç¥ç´šå®Œæˆï¼æˆåŠŸ ${success}/90 å®¶<br>æ·¡æ°´ç«¹åœç¾åœ¨ ${storeData[0].review_count} å‰‡ï¼ˆçµ•å°ä¸æ˜¯éŒ¯èª¤ï¼‰`;
      btn.disabled = false;
    }

    function downloadExcel() {
      const data = [["IVR Code","é–€å¸‚åç¨±","Google Maps","ä¸Šæ¬¡","æœ€æ–°","æ–°å¢","æ›´æ–°æ™‚é–“"], ...storeData.map(s => [s.ivr_code, s.store_name, s.url, s.previous, Number(s.review_count)||0, Number(s.review_count)-Number(s.previous), s.update_time])];
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(data);
      XLSX.utils.book_append_sheet(wb, ws, "é å‚³90å®¶");
      XLSX.writeFile(wb, `é å‚³90å®¶è©•è«–_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    renderTable();
    setTimeout(showApiKeyModal, 1000); // è‡ªå‹•è·³å‡ºé‡‘é‘°è¦–çª—
  </script>
</body>
</html>
